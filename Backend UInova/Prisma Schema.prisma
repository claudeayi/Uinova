generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ============================================================================
 * ENUMS
 * ========================================================================== */
enum UserRole {
  USER
  PREMIUM
  ADMIN
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum ProjectStatus {
  PLANIFIE
  EN_COURS
  TERMINE
}

enum SubscriptionPlan {
  FREE
  PRO
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
}

enum ExportTarget {
  HTML
  REACT
  FLUTTER
  PWA
  ZIP
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  CINETPAY
  MOCK
}

enum PaymentStatus {
  CREATED
  SUCCEEDED
  FAILED
  REFUNDED
}

enum DeploymentStatus {
  PENDING
  RUNNING
  SUCCESS
  ERROR
}

enum PurchaseStatus {
  PENDING
  PAID
  FAILED
}

enum JobStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  RETRY
}

enum WebhookStatus {
  SUCCESS
  FAILED
}

enum AIJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

/* ============================================================================
 * CORE MODELS
 * ========================================================================== */
model User {
  id            String           @id @default(cuid())
  email         String           @unique
  passwordHash  String
  name          String?
  role          UserRole         @default(USER)
  avatarUrl     String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  projects      Project[]
  pages         Page[]           @relation("PageEditors")
  notifications Notification[]
  userBadges    UserBadge[]
  subscriptions Subscription[]
  payments      Payment[]
  uploads       Upload[]
  auditLogs     AuditLog[]
  collabs       CollabHistory[]
  purchases     Purchase[]
  favorites     Favorite[]
  items         MarketplaceItem[]
  replays       ReplaySession[]
  emailLogs     EmailLog[]
  usageRecords  UsageRecord[]
  usageHistory  UsageHistory[]
  sessions      UserSession[]
  apiKeys       ApiKey[]
  memberships   Membership[]
  orgInvites    OrgInvite[]      @relation("Invitee")
  transactions  Transaction[]
  aiJobs        AIJob[]
}

/* ============================================================================
 * ORGANIZATIONS
 * ========================================================================== */
model Organization {
  id          String        @id @default(cuid())
  name        String
  ownerId     String
  owner       User          @relation(fields: [ownerId], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  memberships Membership[]
  projects    Project[]
  invites     OrgInvite[]   @relation("OrgInvites")

  @@index([ownerId])
}

model Membership {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  orgId     String
  org       Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role      OrgRole       @default(MEMBER)
  createdAt DateTime      @default(now())

  @@unique([userId, orgId])
}

model OrgInvite {
  id          String        @id @default(cuid())
  orgId       String
  org         Organization  @relation("OrgInvites", fields: [orgId], references: [id], onDelete: Cascade)
  email       String
  invitedById String
  invitedBy   User          @relation("Invitee", fields: [invitedById], references: [id])
  role        OrgRole       @default(MEMBER)
  accepted    Boolean       @default(false)
  createdAt   DateTime      @default(now())
}

/* ============================================================================
 * PROJECTS
 * ========================================================================== */
model Project {
  id           String         @id @default(cuid())
  name         String
  description  String?
  status       ProjectStatus  @default(PLANIFIE)
  ownerId      String
  owner        User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  orgId        String?
  org          Organization?  @relation(fields: [orgId], references: [id], onDelete: SetNull)
  pages        Page[]
  exports      ExportJob[]
  shareLinks   ShareLink[]
  collabs      CollabHistory[]
  deployments  Deployment[]
  replays      ReplaySession[]
  usageRecords UsageRecord[]
  favorites    Favorite[]
  payments     Payment[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([ownerId])
  @@index([orgId])
}

model Page {
  id          String    @id @default(cuid())
  name        String
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  schemaJSON  Json
  editors     User[]    @relation("PageEditors")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ExportJob {
  id          String        @id @default(cuid())
  projectId   String
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  target      ExportTarget
  status      JobStatus     @default(PENDING)
  resultUrl   String?
  error       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([projectId])
  @@index([target])
  @@index([status])
}

/* ============================================================================
 * BILLING / PAYMENTS
 * ========================================================================== */
model Subscription {
  id               String             @id @default(cuid())
  userId           String
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan             SubscriptionPlan   @default(FREE)
  status           SubscriptionStatus @default(TRIAL)
  currentPeriodEnd DateTime?
  usageLimitJson   Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  payments         Payment[]
  usageRecords     UsageRecord[]
}

model Payment {
  id             String           @id @default(cuid())
  provider       PaymentProvider
  providerRef    String?
  amountCents    Int
  currency       String           @default("EUR")
  status         PaymentStatus    @default(CREATED)
  rawPayload     Json?
  createdAt      DateTime         @default(now())
  userId         String?
  user           User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  subscriptionId String?
  subscription   Subscription?    @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  projectId      String?
  project        Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

model Transaction {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider  PaymentProvider
  amount    Int
  currency  String   @default("EUR")
  status    PaymentStatus
  reference String?
  createdAt DateTime @default(now())
}

/* ============================================================================
 * COMMUNICATION
 * ========================================================================== */
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   @default("info")
  title     String
  body      String?
  channel   String   @default("IN_APP") // IN_APP | EMAIL | PUSH
  actionUrl String?
  meta      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model EmailTemplate {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  subject   String
  bodyHtml  String
  bodyText  String?
  lang      String   @default("fr")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  logs      EmailLog[]
}

model EmailLog {
  id          String   @id @default(cuid())
  templateId  String?
  template    EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  to          String
  subject     String
  body        String
  status      String
  error       String?
  createdAt   DateTime @default(now())
}

/* ============================================================================
 * MARKETPLACE
 * ========================================================================== */
model Badge {
  id        String      @id @default(cuid())
  code      String      @unique
  label     String
  icon      String?
  createdAt DateTime    @default(now())
  users     UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt  DateTime @default(now())
  meta      Json?
}

model MarketplaceItem {
  id          String   @id @default(cuid())
  title       String
  description String?
  priceCents  Int      @default(0)
  currency    String   @default("EUR")
  published   Boolean  @default(true)
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  purchases   Purchase[]
  favorites   Favorite[]
}

model Purchase {
  id        String           @id @default(cuid())
  itemId    String
  item      MarketplaceItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  buyerId   String
  buyer     User             @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  status    PurchaseStatus   @default(PENDING)
  createdAt DateTime         @default(now())
}

model Favorite {
  id         String           @id @default(cuid())
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId  String?
  project    Project?         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  templateId String?
  template   MarketplaceItem? @relation(fields: [templateId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now())
}

/* ============================================================================
 * DEPLOY / REPLAY / COLLAB
 * ========================================================================== */
model Deployment {
  id          String           @id @default(cuid())
  projectId   String
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status      DeploymentStatus @default(PENDING)
  logs        String?
  targetUrl   String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model ReplaySession {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  dataUrl   String
  snapshot  Json?
  stepsCompressed Bytes?
  meta      Json?
  startedAt DateTime @default(now())
  endedAt   DateTime?
}

model CollabHistory {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  changes   Json
  createdAt DateTime @default(now())
}

/* ============================================================================
 * LOGS / SECURITY
 * ========================================================================== */
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  metadata  Json?
  createdAt DateTime @default(now())
}

model ShareLink {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  token     String   @unique
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  expiredAt DateTime?
}

model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  key       String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
}

/* ============================================================================
 * INTEGRATIONS / JOBS / AI
 * ========================================================================== */
model Webhook {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  url       String
  event     String
  createdAt DateTime @default(now())
  deliveries WebhookDelivery[]
}

model WebhookDelivery {
  id        String        @id @default(cuid())
  webhookId String
  webhook   Webhook       @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  status    WebhookStatus
  payload   Json
  response  String?
  createdAt DateTime @default(now())
}

model JobLog {
  id        String   @id @default(cuid())
  queue     String
  jobId     String
  status    JobStatus
  payload   Json?
  result    Json?
  createdAt DateTime @default(now())
}

model AIJob {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String     // ex: generateUI, optimizeUX
  status    AIJobStatus @default(PENDING)
  input     Json
  output    Json?
  createdAt DateTime   @default(now())
  completedAt DateTime?
}
